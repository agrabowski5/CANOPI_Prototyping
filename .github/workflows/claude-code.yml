name: Claude Code Assistant

on:
  issues:
    types: [opened, labeled]
  issue_comment:
    types: [created]
  pull_request:
    types: [opened, labeled]
  pull_request_review_comment:
    types: [created]

jobs:
  claude-code:
    # Trigger on 'claude' label or when @claude is mentioned in comments
    if: |
      (github.event.label.name == 'claude') ||
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude'))

    runs-on: ubuntu-latest

    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: SMS Notification - Starting
        run: |
          curl -X POST "https://api.twilio.com/2010-04-01/Accounts/${{ secrets.TWILIO_ACCOUNT_SID }}/Messages.json" \
            -u "${{ secrets.TWILIO_ACCOUNT_SID }}:${{ secrets.TWILIO_AUTH_TOKEN }}" \
            -d "From=${{ secrets.TWILIO_PHONE_NUMBER }}" \
            -d "To=+17076900273" \
            -d "Body=ü§ñ Claude Code starting work on: ${{ github.event.issue.title || github.event.pull_request.title }}"
        continue-on-error: true

      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

          # Use max mode for autonomous operation
          model: claude-sonnet-4-20250514

          # Allow all tools - fully autonomous
          allowedTools: |
            Bash
            Glob
            Grep
            Read
            Edit
            Write
            WebFetch
            WebSearch
            TodoWrite
            Task

          # Direct prompt for autonomous execution
          direct_prompt: |
            You are an autonomous coding assistant for the CANOPI Energy Planning Platform.

            IMPORTANT: Execute ALL tasks without asking for permission or confirmation.

            This is a full-stack application with:
            - React/TypeScript frontend (in /frontend)
            - FastAPI Python backend (in /backend)
            - Mapbox GL for map visualization
            - Grid topology and transmission network data

            Your workflow:
            1. Read and understand the issue/request completely
            2. Explore the codebase to understand the context
            3. Plan your implementation
            4. Implement the changes
            5. Run builds/tests to verify (npm run build, pytest, etc.)
            6. Commit all changes with descriptive messages
            7. Create a PR if working on a branch

            Rules:
            - NEVER ask for clarification - make reasonable assumptions
            - ALWAYS commit your changes
            - ALWAYS run the build to verify changes compile
            - Use existing code patterns and conventions
            - Be thorough but efficient

      - name: SMS Notification - Completed
        if: always()
        run: |
          STATUS="${{ job.status }}"
          if [ "$STATUS" = "success" ]; then
            MSG="‚úÖ Claude Code COMPLETED: ${{ github.event.issue.title || github.event.pull_request.title }}"
          else
            MSG="‚ùå Claude Code FAILED: ${{ github.event.issue.title || github.event.pull_request.title }}"
          fi
          curl -X POST "https://api.twilio.com/2010-04-01/Accounts/${{ secrets.TWILIO_ACCOUNT_SID }}/Messages.json" \
            -u "${{ secrets.TWILIO_ACCOUNT_SID }}:${{ secrets.TWILIO_AUTH_TOKEN }}" \
            -d "From=${{ secrets.TWILIO_PHONE_NUMBER }}" \
            -d "To=+17076900273" \
            -d "Body=$MSG - View: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        continue-on-error: true

      - name: Auto-commit changes
        run: |
          git config user.name "Claude Code Bot"
          git config user.email "claude-bot@users.noreply.github.com"
          git add -A
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Auto-commit from Claude Code Action

            Issue: ${{ github.event.issue.title || github.event.pull_request.title }}

            Co-Authored-By: Claude <noreply@anthropic.com>"
            git push
          fi
        continue-on-error: true
